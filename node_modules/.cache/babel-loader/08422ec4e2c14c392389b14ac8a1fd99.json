{"ast":null,"code":"'use strict';\n\nconst fs = require('graceful-fs');\n\nconst path = require('path');\n\nconst NODE_VERSION_MAJOR_WITH_BIGINT = 10;\nconst NODE_VERSION_MINOR_WITH_BIGINT = 5;\nconst NODE_VERSION_PATCH_WITH_BIGINT = 0;\nconst nodeVersion = process.versions.node.split('.');\nconst nodeVersionMajor = Number.parseInt(nodeVersion[0], 10);\nconst nodeVersionMinor = Number.parseInt(nodeVersion[1], 10);\nconst nodeVersionPatch = Number.parseInt(nodeVersion[2], 10);\n\nfunction nodeSupportsBigInt() {\n  if (nodeVersionMajor > NODE_VERSION_MAJOR_WITH_BIGINT) {\n    return true;\n  } else if (nodeVersionMajor === NODE_VERSION_MAJOR_WITH_BIGINT) {\n    if (nodeVersionMinor > NODE_VERSION_MINOR_WITH_BIGINT) {\n      return true;\n    } else if (nodeVersionMinor === NODE_VERSION_MINOR_WITH_BIGINT) {\n      if (nodeVersionPatch >= NODE_VERSION_PATCH_WITH_BIGINT) {\n        return true;\n      }\n    }\n  }\n\n  return false;\n}\n\nfunction getStats(src, dest, cb) {\n  if (nodeSupportsBigInt()) {\n    fs.stat(src, {\n      bigint: true\n    }, (err, srcStat) => {\n      if (err) return cb(err);\n      fs.stat(dest, {\n        bigint: true\n      }, (err, destStat) => {\n        if (err) {\n          if (err.code === 'ENOENT') return cb(null, {\n            srcStat,\n            destStat: null\n          });\n          return cb(err);\n        }\n\n        return cb(null, {\n          srcStat,\n          destStat\n        });\n      });\n    });\n  } else {\n    fs.stat(src, (err, srcStat) => {\n      if (err) return cb(err);\n      fs.stat(dest, (err, destStat) => {\n        if (err) {\n          if (err.code === 'ENOENT') return cb(null, {\n            srcStat,\n            destStat: null\n          });\n          return cb(err);\n        }\n\n        return cb(null, {\n          srcStat,\n          destStat\n        });\n      });\n    });\n  }\n}\n\nfunction getStatsSync(src, dest) {\n  let srcStat, destStat;\n\n  if (nodeSupportsBigInt()) {\n    srcStat = fs.statSync(src, {\n      bigint: true\n    });\n  } else {\n    srcStat = fs.statSync(src);\n  }\n\n  try {\n    if (nodeSupportsBigInt()) {\n      destStat = fs.statSync(dest, {\n        bigint: true\n      });\n    } else {\n      destStat = fs.statSync(dest);\n    }\n  } catch (err) {\n    if (err.code === 'ENOENT') return {\n      srcStat,\n      destStat: null\n    };\n    throw err;\n  }\n\n  return {\n    srcStat,\n    destStat\n  };\n}\n\nfunction checkPaths(src, dest, funcName, cb) {\n  getStats(src, dest, (err, stats) => {\n    if (err) return cb(err);\n    const srcStat = stats.srcStat,\n          destStat = stats.destStat;\n\n    if (destStat && destStat.ino && destStat.dev && destStat.ino === srcStat.ino && destStat.dev === srcStat.dev) {\n      return cb(new Error('Source and destination must not be the same.'));\n    }\n\n    if (srcStat.isDirectory() && isSrcSubdir(src, dest)) {\n      return cb(new Error(errMsg(src, dest, funcName)));\n    }\n\n    return cb(null, {\n      srcStat,\n      destStat\n    });\n  });\n}\n\nfunction checkPathsSync(src, dest, funcName) {\n  const _getStatsSync = getStatsSync(src, dest),\n        srcStat = _getStatsSync.srcStat,\n        destStat = _getStatsSync.destStat;\n\n  if (destStat && destStat.ino && destStat.dev && destStat.ino === srcStat.ino && destStat.dev === srcStat.dev) {\n    throw new Error('Source and destination must not be the same.');\n  }\n\n  if (srcStat.isDirectory() && isSrcSubdir(src, dest)) {\n    throw new Error(errMsg(src, dest, funcName));\n  }\n\n  return {\n    srcStat,\n    destStat\n  };\n} // recursively check if dest parent is a subdirectory of src.\n// It works for all file types including symlinks since it\n// checks the src and dest inodes. It starts from the deepest\n// parent and stops once it reaches the src parent or the root path.\n\n\nfunction checkParentPaths(src, srcStat, dest, funcName, cb) {\n  const srcParent = path.resolve(path.dirname(src));\n  const destParent = path.resolve(path.dirname(dest));\n  if (destParent === srcParent || destParent === path.parse(destParent).root) return cb();\n\n  if (nodeSupportsBigInt()) {\n    fs.stat(destParent, {\n      bigint: true\n    }, (err, destStat) => {\n      if (err) {\n        if (err.code === 'ENOENT') return cb();\n        return cb(err);\n      }\n\n      if (destStat.ino && destStat.dev && destStat.ino === srcStat.ino && destStat.dev === srcStat.dev) {\n        return cb(new Error(errMsg(src, dest, funcName)));\n      }\n\n      return checkParentPaths(src, srcStat, destParent, funcName, cb);\n    });\n  } else {\n    fs.stat(destParent, (err, destStat) => {\n      if (err) {\n        if (err.code === 'ENOENT') return cb();\n        return cb(err);\n      }\n\n      if (destStat.ino && destStat.dev && destStat.ino === srcStat.ino && destStat.dev === srcStat.dev) {\n        return cb(new Error(errMsg(src, dest, funcName)));\n      }\n\n      return checkParentPaths(src, srcStat, destParent, funcName, cb);\n    });\n  }\n}\n\nfunction checkParentPathsSync(src, srcStat, dest, funcName) {\n  const srcParent = path.resolve(path.dirname(src));\n  const destParent = path.resolve(path.dirname(dest));\n  if (destParent === srcParent || destParent === path.parse(destParent).root) return;\n  let destStat;\n\n  try {\n    if (nodeSupportsBigInt()) {\n      destStat = fs.statSync(destParent, {\n        bigint: true\n      });\n    } else {\n      destStat = fs.statSync(destParent);\n    }\n  } catch (err) {\n    if (err.code === 'ENOENT') return;\n    throw err;\n  }\n\n  if (destStat.ino && destStat.dev && destStat.ino === srcStat.ino && destStat.dev === srcStat.dev) {\n    throw new Error(errMsg(src, dest, funcName));\n  }\n\n  return checkParentPathsSync(src, srcStat, destParent, funcName);\n} // return true if dest is a subdir of src, otherwise false.\n// It only checks the path strings.\n\n\nfunction isSrcSubdir(src, dest) {\n  const srcArr = path.resolve(src).split(path.sep).filter(i => i);\n  const destArr = path.resolve(dest).split(path.sep).filter(i => i);\n  return srcArr.reduce((acc, cur, i) => acc && destArr[i] === cur, true);\n}\n\nfunction errMsg(src, dest, funcName) {\n  return \"Cannot \".concat(funcName, \" '\").concat(src, \"' to a subdirectory of itself, '\").concat(dest, \"'.\");\n}\n\nmodule.exports = {\n  checkPaths,\n  checkPathsSync,\n  checkParentPaths,\n  checkParentPathsSync,\n  isSrcSubdir\n};","map":null,"metadata":{},"sourceType":"script"}